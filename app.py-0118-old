# Copyright (c) 2026 [è¬å¿ æ‘/Chung Tsun Shieh]. All Rights Reserved.
# app.py
# -*- coding: utf-8 -*-
# Module-Version: v2026.01.23-Final-Restore
# Description: 
# 1. [Sidebar] æ¢å¾©èªè¨€åˆ‡æ› (Language Selector)ã€‚
# 2. [Menu] ç¢ºä¿é¸å–®æ­£ç¢ºé¡¯ç¤ºä¸¦èƒ½èˆ‡å°å…¥åŠŸèƒ½é€£å‹•ã€‚
# 3. [Fix] Ghost Button èˆ‡ åˆå§‹åŒ–é †åºä¿®æ­£ã€‚

import streamlit as st
import sys
import os
from dotenv import load_dotenv

# ==============================================================================
# 1. ç³»çµ±åˆå§‹åŒ– (CRITICAL: å¿…é ˆæ˜¯ç¬¬ä¸€è¡Œ)
# ==============================================================================
st.set_page_config(
    page_title="Math AI Grader Pro", 
    page_icon="ğŸ“", 
    layout="wide", 
    initial_sidebar_state="expanded" 
)

# ==============================================================================
# 2. CSS æ¨£å¼
# ==============================================================================
st.markdown("""
    <style>
    [data-testid="stSidebar"] { color: #333333 !important; background-color: #FAFAFA; }
    [data-testid="stSidebar"] p { font-size: 15px !important; color: #333333 !important; }
    [data-testid="stSidebarCollapsedControl"] {
        display: block !important;
        color: black !important;
        background-color: rgba(200, 200, 200, 0.4) !important; 
        border-radius: 0 8px 8px 0;
        z-index: 999999;
    }
    .mode-box {
        background-color: #E6F2FF;
        border: 1px solid #CCE5FF;
        color: #0056b3;
        padding: 12px;
        border-radius: 6px;
        margin-bottom: 12px;
        font-weight: bold;
        display: flex; align-items: center; gap: 8px;
    }
    .support-btn {
        width: 100%; background-color: white; border: 1px solid #dddddd;
        border-radius: 20px; padding: 10px 0; color: #0066cc;
        text-align: center; font-weight: bold; margin-top: 40px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: default;
    }
    .stRadio > div { gap: 12px; }
    </style>
""", unsafe_allow_html=True)

# ==============================================================================
# 3. æ¨¡çµ„è¼‰å…¥
# ==============================================================================
try:
    from utils.paths import get_resource_path, get_writable_path
    from utils.localization import t
    from services.security import verify_license_tier, get_fingerprint_for_ui
    from database.db_manager import init_db, login_user
    from services.auth_service import validate_session, logout_user
    from services.plans import get_plan_config
    
    from ui.login_view import render_login
    from ui.portal_view import render_portal
    from ui.dashboard_view import render_dashboard
    from ui.exam_gen_view import render_exam_generator
    from ui.history_view import render_history
    from ui.settings_view import render_settings
    from ui.admin_view import render_admin
    from ui.my_exams_view import render_my_exams_view
    from ui.question_bank_view import render_question_bank
    
    from utils.styles import apply_mac_style
    import matplotlib.pyplot as plt
except ImportError as e:
    st.error(f"âŒ Startup Error: {e}")
    st.stop()

LICENSE_PATH = get_writable_path("license.key")

# ==============================================================================
# 4. ä¸»ç¨‹å¼é‚è¼¯
# ==============================================================================
def check_license_gatekeeper():
    if not os.path.exists(LICENSE_PATH): return False
    try:
        is_valid, message, plan, title = verify_license_tier(LICENSE_PATH)
        if not is_valid:
            st.error(f"â›” License Invalid: {message}"); return False
        st.session_state["SYSTEM_PLAN"] = plan
        st.session_state["APP_TITLE"] = title
        if "license_data" not in st.session_state:
            st.session_state["license_data"] = {"features": []} 
        return True
    except: return False

load_dotenv()
init_db()

def main_app():
    if not check_license_gatekeeper():
        st.warning("âš ï¸ è«‹ä¸Šå‚³æœ‰æ•ˆçš„ license.key"); st.stop()

    if "is_authenticated" not in st.session_state:
        st.session_state.update({"is_authenticated": False, "lang": "zh_tw"})
    
    if not st.session_state["is_authenticated"]:
        render_login(); return

    user = st.session_state["user"]
    user.plan = st.session_state.get("SYSTEM_PLAN", "free")

    if "app_mode" not in st.session_state:
        render_portal(user); return

    app_mode = st.session_state.app_mode

    with st.sidebar:
        st.subheader(f"Hi, {user.real_name or user.username}")
        
        # [RESTORED] èªè¨€é¸æ“‡
        st.caption("Language / Langue")
        st.selectbox("Lang", ["ğŸ‡¹ğŸ‡¼ ç¹é«”ä¸­æ–‡", "ğŸ‡ºğŸ‡¸ English"], key="lang_sel", label_visibility="collapsed")
        st.write("") 

        # æ¨¡å¼é¡¯ç¤º
        mode_icon = "ğŸ“" if app_mode == "creator" else "ğŸ“ˆ"
        mode_text = "å‡ºå·ä¸­å¿ƒ" if app_mode == "creator" else "é–±å·ä¸­å¿ƒ"
        st.markdown(f'<div class="mode-box">{mode_icon} Mode: {mode_text}</div>', unsafe_allow_html=True)
        
        if st.button("ğŸ  åˆ‡æ›å·¥ä½œæ¨¡å¼", use_container_width=True, type="primary"):
            del st.session_state.app_mode
            if "page_selection" in st.session_state: del st.session_state.page_selection
            st.rerun()

        st.markdown("---")
        st.caption("è©¦å·è¨­è¨ˆèˆ‡ç®¡ç†")
        
        # é¸å–®çµæ§‹
        if app_mode == "creator":
            menu_structure = [
                ("menu_exam_gen", "è©¦å·ç”Ÿæˆ", render_exam_generator),
                ("menu_my_exams", "æˆ‘çš„è©¦å·åº«", render_my_exams_view),
                ("menu_bank", "é¡Œåº«ä¸­å¿ƒ", render_question_bank),
                ("menu_settings", "å€‹äººè¨­å®š", render_settings),
            ]
            plan_config = get_plan_config(user.plan, st.session_state.get("license_data", {}).get("features", []))
            if getattr(user, "is_admin", False) and plan_config.get("show_admin", False):
                menu_structure.append(("menu_admin", "ç³»çµ±ç®¡ç†", render_admin))
        else:
            menu_structure = [
                ("menu_grading", "é–±å·å„€è¡¨æ¿", render_dashboard),
                ("menu_history", "æ­·å²ç´€éŒ„", render_history),
                ("menu_settings", "å€‹äººè¨­å®š", render_settings),
            ]

        # é é¢å°èˆªé‚è¼¯ (æ”¯æ´å¾å…¶ä»–é é¢è·³è½‰ï¼Œå¦‚ my_exams)
        raw_labels = [m[1] for m in menu_structure]
        
        # 1. æª¢æŸ¥ session state æ˜¯å¦æœ‰å¤–éƒ¨è«‹æ±‚è·³è½‰ (ä¾‹å¦‚å¾ My Exams é»äº†å°å…¥)
        requested_page_key = st.session_state.get("page_selection") 
        # å°‡ key (menu_exam_gen) è½‰æ›ç‚º Label (è©¦å·ç”Ÿæˆ)
        target_label_from_key = None
        if requested_page_key:
            for item in menu_structure:
                if item[0] == requested_page_key:
                    target_label_from_key = item[1]
                    break
        
        # 2. æ±ºå®šç•¶å‰é¸å–
        current_selection = st.session_state.get("page_selection_clean", raw_labels[0])
        
        # å¦‚æœæœ‰å¤–éƒ¨è·³è½‰è«‹æ±‚ï¼Œå„ªå…ˆä½¿ç”¨
        if target_label_from_key and target_label_from_key in raw_labels:
            current_selection = target_label_from_key
            # æ¸…é™¤è«‹æ±‚ï¼Œé¿å…å¡æ­»
            st.session_state.page_selection = None 
            st.session_state.page_selection_clean = current_selection

        if current_selection not in raw_labels: current_selection = raw_labels[0]
            
        display_labels = []
        for label in raw_labels:
            if label == current_selection: display_labels.append(f"ğŸ”´ {label}")
            else: display_labels.append(f"âšª {label}")
        
        label_map = {d: m for d, m in zip(display_labels, menu_structure)}
        curr_idx = raw_labels.index(current_selection)

        sel = st.radio("Navigation", display_labels, index=curr_idx, label_visibility="collapsed", key="nav_radio")
        
        selected_item = label_map[sel]
        clean_label = selected_item[1]
        target_func = selected_item[2]

        if st.session_state.get("page_selection_clean") != clean_label:
            st.session_state.page_selection_clean = clean_label
            st.rerun()

        st.markdown("---")
        if st.button("ç™»å‡º", use_container_width=True, type="secondary"):
            logout_user(); st.rerun()

        st.markdown(f'<div class="support-btn">âœ¨ Support Mathematics</div>', unsafe_allow_html=True)

    if target_func: target_func(user)
    else: st.error(f"View not found")

if __name__ == "__main__":
    main_app()
