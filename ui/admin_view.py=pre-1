# ui/admin_view.py
# -*- coding: utf-8 -*-
# Module-Version: v2026.01.05-Admin-Business-Fix

import streamlit as st
import pandas as pd
from database.db_manager import get_all_users, update_user, get_all_usage_stats, User
from utils.localization import t

def render_admin(user: User):
    """æ©Ÿæ§‹ç‰ˆç®¡ç†å“¡å¾Œå° (Business Admin)"""
    st.title(f"ğŸ›¡ï¸ {t('admin_title')}")
    
    if not user or not user.is_admin:
        st.error(t("warn_admin_only"))
        return

    # ç°¡åŒ–å¾Œçš„ Tabsï¼šåªä¿ç•™ã€Œç”¨æˆ¶ç®¡ç†ã€èˆ‡ã€Œçµ±è¨ˆã€
    tab1, tab2 = st.tabs([f"ğŸ“Š {t('admin_tab_stats')}", f"ğŸ‘¥ {t('admin_tab_users')}"])

    with tab1: _render_stats_dashboard()
    with tab2: _render_user_management()

def _render_stats_dashboard():
    st.subheader(f"ğŸ’° {t('admin_stats_usage_title')}")
    try:
        usage_df = get_all_usage_stats()
        if not usage_df.empty:
            st.dataframe(usage_df, width='stretch')
        else:
            st.info(t("admin_stats_no_data"))
    except Exception as e:
        st.error(f"Error: {e}")

def _render_user_management():
    st.subheader(f"ğŸ‘¥ {t('admin_user_mgmt_title')}")
    
    users = get_all_users()
    if not users:
        st.warning(t("admin_no_data"))
        return

    # é¡¯ç¤ºç”¨æˆ¶åˆ—è¡¨
    df = pd.DataFrame(users)
    valid_cols = [c for c in ["id", "username", "real_name", "email", "plan", "custom_page_limit"] if c in df.columns]
    st.dataframe(df[valid_cols], width='stretch', hide_index=True)

    st.markdown("---")
    st.markdown(f"### âœï¸ {t('admin_user_edit_status')}")
    
    user_opts = {u['id']: f"{u['username']} ({u['real_name']})" for u in users}
    selected_uid = st.selectbox(t("admin_user_select_label"), options=list(user_opts.keys()), format_func=lambda x: user_opts[x])
    
    if selected_uid:
        target = next((u for u in users if u['id'] == selected_uid), None)
        if target:
            with st.form(key=f"edit_u_{selected_uid}"):
                st.info("æ‚¨å¯åœ¨æ­¤èª¿æ•´å…§éƒ¨å“¡å·¥çš„é…é¡ä¸Šé™ (Business Admin Only)")
                
                # [ä¿®æ­£] æ–¹æ¡ˆé¸æ“‡åªæœ‰ Personal / Business
                plan_list = ["personal", "business"]
                curr_plan = target.get('plan', 'personal')
                if curr_plan not in plan_list: plan_list.append(curr_plan) # fallback
                
                new_plan = st.selectbox(t("admin_user_plan_label"), plan_list, index=plan_list.index(curr_plan))
                
                # é…é¡èª¿æ•´
                c_page_limit = st.number_input("æ¯é€±é–±å·ä¸Šé™ (Custom Quota)", value=int(target.get('custom_page_limit') or 0))
                
                # åªæœ‰åˆ‡æ›æˆ Business æ‰èƒ½é–‹ Admin æ¬Šé™
                new_adm = False
                if new_plan == "business":
                    new_adm = st.checkbox("æˆäºˆç®¡ç†å“¡æ¬Šé™ (Is Admin?)", value=bool(target.get('is_admin')))

                if st.form_submit_button(t("admin_user_update_btn"), type="primary"):
                    success = update_user(
                        selected_uid, 
                        plan=new_plan,
                        is_admin=new_adm,
                        custom_page_limit=c_page_limit
                    )
                    if success:
                        st.success(t("admin_user_update_success").format(username=target['username']))
                        st.rerun()