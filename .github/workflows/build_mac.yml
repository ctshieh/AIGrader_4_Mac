name: Build AI Grader Pro MacOS (Python 3.13)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-macos:
    runs-on: macos-15
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up Python 3.13
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'

    - name: Install System Tools & Poppler
      run: |
        brew install create-dmg poppler dylibbundler
        mkdir -p dist_bin
        cp $(brew --prefix poppler)/bin/pdftoppm dist_bin/
        cp $(brew --prefix poppler)/bin/pdfinfo dist_bin/
        cp $(brew --prefix poppler)/bin/pdftocairo dist_bin/

    - name: Fix Poppler Dependencies
      run: |
        dylibbundler -x dist_bin/pdftoppm -b -d dist_bin/ -p @executable_path/ -of
        dylibbundler -x dist_bin/pdfinfo -b -d dist_bin/ -p @executable_path/ -of
        dylibbundler -x dist_bin/pdftocairo -b -d dist_bin/ -p @executable_path/ -of
        chmod +x dist_bin/*

    - name: Install Python Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller Cython wheel setuptools

    - name: Cython Compilation
      run: python build_cython.py

    - name: Build .app with PyInstaller
      run: |
        # 注意：名稱中有空格，必須使用引號
        pyinstaller --noconfirm --onedir --windowed --name "AI Grader Pro" \
          --target-arch arm64 \
          --add-data "dist_bin:poppler_bin" \
          --add-data "fonts:fonts" \
          --add-data "assets:assets" \
          --add-data "app.py:." \
          run_native.py

    - name: Create DMG Installer
      run: |
        cd dist
        create-dmg \
          --volname "AI Grader Pro Installer" \
          --window-pos 200 120 \
          --window-size 800 400 \
          --icon-size 100 \
          --icon "AI Grader Pro.app" 200 190 \
          --app-drop-link 600 185 \
          "AI_Grader_Pro_MacOS.dmg" \
          "AI Grader Pro.app"

    - name: Upload Result
      uses: actions/upload-artifact@v4
      with:
        name: AI-Grader-Pro-MacOS-DMG
        path: dist/AI_Grader_Pro_MacOS.dmg
