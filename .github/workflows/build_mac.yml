# .github/workflows/build_mac.yml
name: Build macOS Silicon App (DMG)

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14 # Apple Silicon Runner

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13' # 確保與專案 3.13 一致

    - name: Install System Tools
      run: |
        # 安裝本地腳本所需的依賴
        brew install create-dmg poppler dylibbundler

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller Cython wheel setuptools

    # 關鍵步驟：呼叫您的本地自動化腳本
    - name: Execute Build Offline Script
      run: |
        chmod +x build_offline.sh
        ./build_offline.sh # 執行 Cython、Poppler 處理與 PyInstaller

    # 製作 .dmg 安裝檔 (修正檔名對齊 AIGrader.spec)
    - name: Create DMG Installer
      run: |
        cd dist
        # 注意：檔名必須完全對齊 AIGrader.spec 中的 name
        create-dmg \
          --volname "AI Grader Pro Installer" \
          --window-pos 200 120 \
          --window-size 800 400 \
          --icon-size 100 \
          --icon "AI Grader Pro.app" 200 190 \
          --hide-extension "AI Grader Pro.app" \
          --app-drop-link 600 185 \
          "AI_Grader_Pro_Installer_Silicon.dmg" \
          "AI Grader Pro.app"

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: AI-Grader-Pro-Silicon-DMG
        path: dist/AI_Grader_Pro_Installer_Silicon.dmg
