# Copyright (c) 2026 [è¬å¿ æ‘/Chung Tsun Shieh]. All Rights Reserved.
# app.py
# -*- coding: utf-8 -*-
# Version: v2026.01.22-Classic-Menu-Restored
# Description: å›æ­¸ 0115 ç‰ˆæœ¬çš„ä¸­å¤®é›†æ¬Šé¸å–®æ¶æ§‹ï¼Œä¸¦æ•´åˆæ–°åŠŸèƒ½èˆ‡å¤šåœ‹èªè¨€ã€‚

import streamlit as st
import base64
import os
import matplotlib.pyplot as plt
import matplotlib.font_manager as fm

# 1. æ ¸å¿ƒæ¨¡çµ„åŒ¯å…¥
from database.db_manager import login_user
from utils.localization import t, set_language
import utils.helpers as helpers

# 2. UI è¦–åœ–åŒ¯å…¥
from ui.login_view import render_login
from ui.portal_view import render_portal
from ui.dashboard_view import render_dashboard
from ui.settings_view import render_settings
from ui.history_view import render_history
from ui.exam_gen_view import render_exam_generator
# [NEW] åŒ¯å…¥æ–°åŠŸèƒ½æ¨¡çµ„
from ui.my_exams_view import render_my_exams_view
from ui.question_bank_view import render_question_bank
# [Optional] è§£ç­”ç·¨è¼¯å™¨ (è‹¥éœ€è¦å¯å•Ÿç”¨)
# from ui.solution_editor_view import render_solution_editor

# ==========================================
# ç¬¬ä¸€æ­¥ï¼šç’°å¢ƒå„ªåŒ– - å­—é«”èˆ‡æ¨™é»ç¬¦è™Ÿé è¼‰
# ==========================================
def init_font_settings():
    try:
        pref_fonts = ['cwTeX Q Hei', 'Noto Sans CJK TC', 'PingFang HK', 'Heiti TC']
        sys_fonts = [f.name for f in fm.fontManager.ttflist]
        for f in pref_fonts:
            if f in sys_fonts:
                plt.rcParams['font.sans-serif'] = [f]
                break
        plt.rcParams['axes.unicode_minus'] = False
    except:
        pass

init_font_settings()

# ==========================================
# ç¬¬äºŒæ­¥ï¼šPDF å°è¦½æ³¨å…¥
# ==========================================
def patched_display_pdf(file_input, height=750):
    try:
        col_back, col_info = st.columns([1, 4])
        with col_back:
            if st.button(f"â¬…ï¸ {t('btn_back', 'è¿”å›')}", key="nav_pdf_back", type="primary"):
                st.session_state.view_pdf_data = None
                st.rerun()
        with col_info:
            st.caption(f"â„¹ï¸ {t('pdf_preview_mode', 'é è¦½æ¨¡å¼')}")

        data = file_input.getvalue() if hasattr(file_input, "getvalue") else file_input
        base64_pdf = base64.b64encode(data).decode('utf-8')
        
        pdf_display = f'''
            <div style="border:2px solid #1A365D; border-radius:12px; overflow:hidden; max-height:{height}px;">
                <embed src="data:application/pdf;base64,{base64_pdf}" width="100%" height="{height}px" type="application/pdf" />
            </div>'''
        st.markdown(pdf_display, unsafe_allow_html=True)
    except Exception as e:
        st.error(f"PDF Error: {e}")

helpers.display_pdf = patched_display_pdf

# ==========================================
# ä¸»ç¨‹å¼é‚è¼¯ (Classic Mode)
# ==========================================
def main():
    st.set_page_config(page_title="NewEra Tools", page_icon="ğŸ“", layout="wide")

    # A. Session ç‹€æ…‹åˆå§‹åŒ–
    if "is_authenticated" not in st.session_state:
        st.session_state["is_authenticated"] = False
    if "user" not in st.session_state:
        st.session_state["user"] = None
    if "lang" not in st.session_state:
        st.session_state["lang"] = "zh_tw"
    if "view_pdf_data" not in st.session_state:
        st.session_state.view_pdf_data = None

    # B. ç™»å…¥æª¢æŸ¥
    if not st.session_state["is_authenticated"]:
        render_login()
        return

    user = st.session_state["user"]

    # C. Portal è·¯ç”±
    if "app_mode" not in st.session_state:
        render_portal(user)
        return

    app_mode = st.session_state["app_mode"]

    # ==========================================
    # D. ä¸­å¤®é›†æ¬Šå´é‚Šæ¬„ (The 0115 Way)
    # ==========================================
    with st.sidebar:
        st.title("NewEra Tools")
        st.markdown(f"ğŸ‘¤ **{user.username}**")
        st.caption(f"Mode: {app_mode.title()}")

        # 1. æ¨¡å¼åˆ‡æ›
        if st.button(f"ğŸ”„ {t('btn_portal', 'åˆ‡æ›æ¨¡å¼')}", use_container_width=True):
            del st.session_state["app_mode"]
            if "page_selection" in st.session_state: del st.session_state.page_selection
            st.rerun()

        st.markdown("---")

        # 2. å®šç¾©é¸å–®çµæ§‹ (Key, Function)
        menu_items = []
        
        if app_mode == "creator":
            # å‡ºå·æ¨¡å¼é¸å–®
            menu_items.append(("menu_exam_gen", render_exam_generator))
            menu_items.append(("menu_my_exams", render_my_exams_view))
            menu_items.append(("menu_bank", render_question_bank))
            # menu_items.append(("menu_solution", render_solution_editor)) # è‹¥éœ€è¦å¯å•Ÿç”¨
        else:
            # é–±å·æ¨¡å¼é¸å–®
            menu_items.append(("menu_grading", render_dashboard))
            menu_items.append(("menu_history", render_history))
        
        # é€šç”¨é¸å–®
        menu_items.append(("menu_settings", render_settings))

        # 3. æ¸²æŸ“ st.radio é¸å–®
        # ä½¿ç”¨ format_func é€²è¡Œå¤šåœ‹èªè¨€ç¿»è­¯
        options = [item[0] for item in menu_items]
        
        # ç‹€æ…‹ä¿æŒï¼šé¿å… rerun æ™‚é¸å–®é‡ç½®
        idx = 0
        if "page_selection" in st.session_state:
            if st.session_state.page_selection in options:
                idx = options.index(st.session_state.page_selection)

        selection = st.radio(
            t("menu_title", "åŠŸèƒ½å°è¦½"),
            options,
            index=idx,
            format_func=lambda x: t(x), # è‡ªå‹•ç¿»è­¯ Key -> Label
            key="page_selection"
        )

        st.markdown("---")

        # 4. èªç³»åˆ‡æ› (ä¿ç•™æ‚¨çš„éœ€æ±‚)
        langs = {"zh_tw": "ç¹é«”ä¸­æ–‡", "en": "English", "ja": "æ—¥æœ¬èª", "fr": "FranÃ§ais"}
        current_lang_key = st.session_state.get("lang", "zh_tw")
        if current_lang_key not in langs: current_lang_key = "zh_tw"
        
        new_lang = st.selectbox("Language", options=list(langs.keys()), 
                                format_func=lambda x: langs[x],
                                index=list(langs.keys()).index(current_lang_key))
        
        if new_lang != st.session_state.lang:
            st.session_state.lang = new_lang
            set_language(new_lang)
            st.rerun()

        # 5. ç™»å‡º
        if st.button(t("logout_btn", "ç™»å‡º"), use_container_width=True):
            st.session_state.clear()
            st.rerun()

        # 6. Brand Footer (From 0115)
        st.markdown("""
            <div style="margin-top: 20px; text-align: center; opacity: 0.7; font-size: 0.8rem;">
                ğŸš€ <b>Next_Gen Educational Tools</b><br>
                Future of Intelligent Grading
            </div>
        """, unsafe_allow_html=True)

    # ==========================================
    # E. é é¢åˆ†æµåŸ·è¡Œ
    # ==========================================
    # æ‰¾åˆ°å°æ‡‰çš„æ¸²æŸ“å‡½æ•¸ä¸¦åŸ·è¡Œ
    target_func = next((item[1] for item in menu_items if item[0] == selection), None)
    
    if target_func:
        target_func(user)
    else:
        st.error(f"View not found for: {selection}")

if __name__ == "__main__":
    main()
