# Copyright (c) 2026 [è¬å¿ æ‘/Chung Tsun Shieh]. All Rights Reserved.
# app.py
# -*- coding: utf-8 -*-
# Version: v2026.01.15-Final-Integrated-Portal-Fix

import streamlit as st
import base64
import os
import matplotlib.pyplot as plt
import matplotlib.font_manager as fm

# 1. æ ¸å¿ƒæ¨¡çµ„åŒ¯å…¥
from database.db_manager import login_user
from utils.localization import t, set_language
import utils.helpers as helpers

# 2. UI è¦–åœ–åŒ¯å…¥
from ui.login_view import render_login
from ui.portal_view import render_portal
from ui.dashboard_view import render_dashboard
from ui.settings_view import render_settings
from ui.history_view import render_history
from ui.exam_gen_view import render_exam_generator

# ==========================================
# ç¬¬ä¸€æ­¥ï¼šç’°å¢ƒå„ªåŒ– - å­—é«”èˆ‡æ¨™é»ç¬¦è™Ÿé è¼‰
# ==========================================
def init_font_settings():
    """é‡å° Mac M4 å„ªåŒ–æ¨™é»ç¬¦è™Ÿä½ç½®ï¼Œå„ªå…ˆå°‹æ‰¾ cwTeX æˆ– Noto"""
    try:
        # å®šç¾©å„ªå…ˆé †åºï¼šcwTeX (ç½®åº•æœ€å¼·) > Noto (é–‹æºé¦–é¸) > ç³»çµ±é è¨­
        pref_fonts = ['cwTeX Q Hei', 'Noto Sans CJK TC', 'PingFang HK', 'Heiti TC']
        sys_fonts = [f.name for f in fm.fontManager.ttflist]
        for f in pref_fonts:
            if f in sys_fonts:
                plt.rcParams['font.sans-serif'] = [f]
                break
        plt.rcParams['axes.unicode_minus'] = False
    except:
        pass

init_font_settings()

# ==========================================
# ç¬¬äºŒæ­¥ï¼šä¸ä¿®æ”¹ä¹‹ä¿®æ”¹ - PDF å°è¦½æ³¨å…¥
# ==========================================
def patched_display_pdf(file_input, height=750):
    """æ³¨å…¥å°è¦½åˆ—ä»¥è§£æ±º Native App PDF é®è”½å•é¡Œï¼Œæ”¯æ´å››åœ‹èªç³»"""
    try:
        col_back, col_info = st.columns([1, 4])
        with col_back:
            if st.button(f"â¬…ï¸ {t('btn_back', 'è¿”å›')}", key="nav_pdf_back", type="primary"):
                st.session_state.view_pdf_data = None
                st.rerun()
        with col_info:
            st.caption(f"â„¹ï¸ {t('pdf_preview_mode', 'é è¦½æ¨¡å¼')}")

        data = file_input.getvalue() if hasattr(file_input, "getvalue") else file_input
        base64_pdf = base64.b64encode(data).decode('utf-8')
        
        pdf_display = f'''
            <div style="border:2px solid #1A365D; border-radius:12px; overflow:hidden; max-height:{height}px;">
                <embed src="data:application/pdf;base64,{base64_pdf}" width="100%" height="{height}px" type="application/pdf" />
            </div>'''
        st.markdown(pdf_display, unsafe_allow_html=True)
    except Exception as e:
        st.error(f"PDF Error: {e}")

helpers.display_pdf = patched_display_pdf

# ==========================================
# ç¬¬ä¸‰æ­¥ï¼šä¸»ç¨‹å¼é‚è¼¯
# ==========================================
def main():
    st.set_page_config(page_title="NewEra Tools", page_icon="ğŸ“", layout="wide")

    # A. Session ç‹€æ…‹åˆå§‹åŒ–
    if "is_authenticated" not in st.session_state:
        st.session_state["is_authenticated"] = False
    if "user" not in st.session_state:
        st.session_state["user"] = None
    if "lang" not in st.session_state:
        st.session_state["lang"] = "zh_tw"
    if "view_pdf_data" not in st.session_state:
        st.session_state.view_pdf_data = None

    # B. ç™»å…¥æª¢æŸ¥
    if not st.session_state["is_authenticated"]:
        render_login()
        return

    user = st.session_state["user"]

    # C. é‡è¦ï¼šPortal è·¯ç”±é‚è¼¯ (è§£æ±ºè·³é Portal çš„å•é¡Œ)
    if "app_mode" not in st.session_state:
        render_portal(user)
        return

    # D. åŠŸèƒ½æ¨¡å¼å´é‚Šæ¬„
    app_mode = st.session_state["app_mode"]
    
    with st.sidebar:
        st.title("NewEra Tools")
        st.markdown(f"ğŸ‘¤ **{user['username'] if isinstance(user, dict) else user.username}**")
        
        # æ¨¡å¼åˆ‡æ›æŒ‰éˆ•
        if st.button(f"ğŸ  {t('btn_portal', 'è¿”å›å…¥å£ä¸­å¿ƒ')}", use_container_width=True):
            del st.session_state["app_mode"]
            st.rerun()
        
        st.divider()
        
        # æ ¹æ“šæ¨¡å¼å®šç¾©é¸å–®
        if app_mode == "creator":
            # å‡ºå·æ¨¡å¼é¸å–®
            menu_options = {
                "ExamGen": f"ğŸ“ {t('menu_exam_gen', 'è‡ªå‹•å‡ºå·')}",
                "Settings": f"âš™ï¸ {t('menu_settings', 'ç³»çµ±è¨­å®š')}"
            }
        else:
            # é–±å·æ¨¡å¼é¸å–®
            menu_options = {
                "Grading": f"ğŸ“ {t('menu_grading', 'è‡ªå‹•é–±å·')}",
                "History": f"ğŸ“Š {t('menu_history', 'åˆ†æå ±å‘Š')}",
                "Settings": f"âš™ï¸ {t('menu_settings', 'ç³»çµ±è¨­å®š')}"
            }
        
        choice = st.radio(
            t("menu_title", "åŠŸèƒ½å°è¦½"),
            options=list(menu_options.keys()),
            format_func=lambda x: menu_options[x]
        )
        
        # èªç³»åˆ‡æ› (zh_tw, en, ja, fr)
        st.divider()
        langs = {"zh_tw": "ç¹é«”ä¸­æ–‡", "en": "English", "ja": "æ—¥æœ¬èª", "fr": "FranÃ§ais"}
        new_lang = st.selectbox("Language", options=list(langs.keys()), 
                                format_func=lambda x: langs[x],
                                index=list(langs.keys()).index(st.session_state.lang))
        if new_lang != st.session_state.lang:
            st.session_state.lang = new_lang
            set_language(new_lang)
            st.rerun()

        if st.button(t("logout_btn", "ç™»å‡º"), use_container_width=True):
            st.session_state.clear()
            st.rerun()

    # E. é é¢åˆ†æµæ¸²æŸ“
    if choice == "Grading":
        render_dashboard(user)
    elif choice == "History":
        render_history(user)
    elif choice == "ExamGen":
        render_exam_generator(user)
    elif choice == "Settings":
        render_settings(user)

if __name__ == "__main__":
    main()
